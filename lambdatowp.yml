AWSTemplateFormatVersion: '2010-09-09'
Resources:
  LambdaExecutionRolewp:
    Type: 'AWS::IAM::Role'
    Properties:
      RoleName: LambdaExecutionRolewp
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: 'Allow'
            Principal:
              Service:
                - 'lambda.amazonaws.com'
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole'
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'

  LambdaFunction:
    Type: 'AWS::Lambda::Function'
    Properties:
      FunctionName: MyEC2DockerRunFunction1
      Runtime: 'python3.8'
      Handler: index.lambda_handler
      Role: !GetAtt LambdaExecutionRolewp.Arn
      Timeout: 60
      Code:
        ZipFile: |
          import boto3

          def lambda_handler(event, context):
              # Replace INSTANCE_ID with the EC2 instance ID you want to execute the command on
              instance_id = 'i-0a3ebf62f318a6bd5'
              command = 'sudo docker container run --name wp1 -d -p 172.56.11.65:8080:80 2b5691e73f15'

              client = boto3.client('ssm')
              response = client.send_command(
                  InstanceIds=[instance_id],
                  DocumentName='AWS-RunShellScript',
                  Parameters={
                      'commands': [command],
                      'executionTimeout': ['3600']
                  }
              )

              return {
                  'statusCode': 200,
              }
